
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meraglim Web Recon Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .subdomain-item {
            transition: all 0.2s ease;
        }
        .subdomain-item:hover {
            transform: translateY(-2px);
        }
        .subdomain-item.selected {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .checkbox-custom {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #4b5563;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        .checkbox-custom:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .checkbox-custom:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #10b981;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-blue-400">
                        <i class="fas fa-search mr-2"></i>Meraglim - Web Recon Framework
                    </h1>
                    <p class="text-gray-400 mt-2">Advanced reconnaissance with JavaScript analysis and endpoint harvesting</p>
                </div>
                <div class="flex space-x-4">
                    <a href="/dashboard" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="/reports" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                        <i class="fas fa-file-alt mr-2"></i>Reports
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Scan Form -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-xl p-6 shadow-2xl">
                    <h2 class="text-2xl font-bold mb-6 text-green-400">
                        <i class="fas fa-rocket mr-2"></i>Start New Scan
                    </h2>
                    
                    <!-- Discovery Form -->
                    <div id="discoveryForm">
                        <!-- Domain Input -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">
                                <i class="fas fa-globe mr-2"></i>Target Domain
                            </label>
                            <input type="text" id="domain" name="domain" 
                                   class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="example.com" required>
                        </div>

                        <!-- Tools Selection -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">
                                <i class="fas fa-tools mr-2"></i>Enumeration Tools
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="tool_subfinder" name="tools" value="subfinder" class="mr-2">
                                    <label for="tool_subfinder" class="cursor-pointer">Subfinder</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="tool_amass" name="tools" value="amass" class="mr-2">
                                    <label for="tool_amass" class="cursor-pointer">Amass</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="tool_assetfinder" name="tools" value="assetfinder" class="mr-2">
                                    <label for="tool_assetfinder" class="cursor-pointer">Assetfinder</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="tool_crtsh" name="tools" value="crt.sh" class="mr-2" checked>
                                    <label for="tool_crtsh" class="cursor-pointer">crt.sh</label>
                                </div>
                            </div>
                        </div>

                        <!-- Discovery Button -->
                        <button type="button" id="startDiscoveryBtn" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-lg font-bold text-lg transition transform hover:scale-[1.02] mb-4">
                            <i class="fas fa-search mr-2"></i>Discover Subdomains
                        </button>
                    </div>

                    <!-- Subdomain Selection (Hidden by default) -->
                    <div id="subdomainSelection" class="hidden">
                        <!-- Selection Header -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-yellow-400">
                                <i class="fas fa-list-check mr-2"></i>Select Subdomains to Scan
                            </h3>
                            <div class="text-sm text-gray-400">
                                Selected: <span id="selectedCount">0</span> / <span id="totalCount">0</span>
                            </div>
                        </div>

                        <!-- Selection Controls -->
                        <div class="flex space-x-3 mb-4">
                            <button type="button" onclick="selectAll()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                                <i class="fas fa-check-square mr-2"></i>Select All
                            </button>
                            <button type="button" onclick="deselectAll()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                                <i class="fas fa-square mr-2"></i>Deselect All
                            </button>
                        </div>

                        <!-- Subdomain List -->
                        <div class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto mb-4" id="subdomainList">
                            <!-- Subdomains will be loaded here -->
                        </div>

                        <!-- Scan Configuration -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">
                                <i class="fas fa-cogs mr-2"></i>Scan Mode
                            </label>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="relative">
                                    <input type="radio" id="mode1" name="scan_mode" value="1" class="hidden peer" checked>
                                    <label for="mode1" class="block p-4 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer text-center peer-checked:border-blue-500 peer-checked:bg-blue-900/30 hover:bg-gray-600 transition">
                                        <i class="fas fa-link text-xl mb-2"></i>
                                        <div>URL Scan Only</div>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" id="mode2" name="scan_mode" value="2" class="hidden peer">
                                    <label for="mode2" class="block p-4 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer text-center peer-checked:border-blue-500 peer-checked:bg-blue-900/30 hover:bg-gray-600 transition">
                                        <i class="fab fa-js text-xl mb-2"></i>
                                        <div>JavaScript Only</div>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" id="mode3" name="scan_mode" value="3" class="hidden peer">
                                    <label for="mode3" class="block p-4 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer text-center peer-checked:border-blue-500 peer-checked:bg-blue-900/30 hover:bg-gray-600 transition">
                                        <i class="fas fa-expand text-xl mb-2"></i>
                                        <div>Full Scan</div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- JavaScript Analysis -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">
                                <i class="fab fa-js mr-2"></i>JavaScript Analysis
                            </label>
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input type="radio" id="js_analysis_yes" name="js_analysis" value="yes" class="mr-2" checked>
                                    <label for="js_analysis_yes" class="cursor-pointer">Enable</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="js_analysis_no" name="js_analysis" value="no" class="mr-2">
                                    <label for="js_analysis_no" class="cursor-pointer">Disable</label>
                                </div>
                            </div>
                            <p class="text-sm text-gray-400 mt-1">
                                Extract hidden endpoints and secrets from JavaScript files
                            </p>
                        </div>

                        <!-- Endpoint Verification -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">
                                <i class="fas fa-shield-alt mr-2"></i>Endpoint Verification
                            </label>
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input type="radio" id="verify_no" name="verify_endpoints" value="no" class="mr-2" checked>
                                    <label for="verify_no" class="cursor-pointer">Skip</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="verify_sample" name="verify_endpoints" value="sample" class="mr-2">
                                    <label for="verify_sample" class="cursor-pointer">Sample</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="verify_full" name="verify_endpoints" value="yes" class="mr-2">
                                    <label for="verify_full" class="cursor-pointer">Full</label>
                                </div>
                            </div>
                        </div>

                        <!-- Endpoint Harvesting -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">
                                <i class="fas fa-database mr-2"></i>Smart Endpoint Harvesting
                            </label>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">
                                        Automatically collect discovered endpoints into wordlist for future scans
                                    </p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="endpoint_harvesting" name="endpoint_harvesting">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-2 flex space-x-2">
                                <button type="button" onclick="viewHarvestedEndpoints()" class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 rounded">
                                    View
                                </button>
                                <button type="button" onclick="exportHarvestedEndpoints()" class="px-3 py-1 text-sm bg-green-600 hover:bg-green-700 rounded">
                                    Export
                                </button>
                                <button type="button" onclick="clearHarvestedEndpoints()" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 rounded">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- Scan Button -->
                        <button type="button" id="startSelectedScanBtn" class="w-full py-3 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 rounded-lg font-bold text-lg transition transform hover:scale-[1.02]">
                            <i class="fas fa-play mr-2"></i>Start Scan with Selected Subdomains
                        </button>

                        <!-- Back Button -->
                        <button type="button" onclick="showDiscoveryForm()" class="w-full mt-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Discovery
                        </button>
                    </div>
                </div>

                <!-- Tool Status -->
                <div class="mt-6 bg-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">
                        <i class="fas fa-clipboard-check mr-2"></i>Tool Status
                    </h3>
                    <div id="toolStatus" class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <!-- Tool status will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Instructions & Stats -->
            <div class="space-y-6">
                <!-- Quick Guide -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 text-purple-400">
                        <i class="fas fa-lightbulb mr-2"></i>Quick Guide
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="bg-blue-500 rounded-full p-2 mr-3 mt-1">
                                <i class="fas fa-1 text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">Enter Domain</h4>
                                <p class="text-sm text-gray-400">Enter the target domain to scan</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-blue-500 rounded-full p-2 mr-3 mt-1">
                                <i class="fas fa-2 text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">Discover Subdomains</h4>
                                <p class="text-sm text-gray-400">Use tools to find all subdomains</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-blue-500 rounded-full p-2 mr-3 mt-1">
                                <i class="fas fa-3 text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">Select Subdomains</h4>
                                <p class="text-sm text-gray-400">Choose which subdomains to scan</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-blue-500 rounded-full p-2 mr-3 mt-1">
                                <i class="fas fa-4 text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">Configure & Scan</h4>
                                <p class="text-sm text-gray-400">Set options and start the scan</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Scans -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 text-red-400">
                        <i class="fas fa-history mr-2"></i>Recent Scans
                    </h3>
                    <div id="recentScans" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Recent scans will be loaded here -->
                    </div>
                </div>

                <!-- Stats -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 text-green-400">
                        <i class="fas fa-chart-bar mr-2"></i>Statistics
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-gray-900 rounded-lg">
                            <div class="text-2xl font-bold text-blue-400" id="totalScans">0</div>
                            <div class="text-sm text-gray-400">Total Scans</div>
                        </div>
                        <div class="text-center p-3 bg-gray-900 rounded-lg">
                            <div class="text-2xl font-bold text-green-400" id="completedScans">0</div>
                            <div class="text-sm text-gray-400">Completed</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discovery Progress Modal -->
        <div id="discoveryProgressModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-400">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Discovering Subdomains
                    </h3>
                    <button onclick="closeDiscoveryModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span id="discoveryProgressText">Initializing...</span>
                        <span id="discoveryProgressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="discoveryProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto mb-4">
                    <div id="discoveryLogs" class="space-y-2">
                        <!-- Discovery logs will appear here -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button id="stopDiscoveryBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                        <i class="fas fa-stop mr-2"></i>Stop Discovery
                    </button>
                </div>
            </div>
        </div>

        <!-- Scan Progress Modal -->
        <div id="scanProgressModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-400">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Scan in Progress
                    </h3>
                    <button onclick="closeScanModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span id="scanProgressText">Initializing...</span>
                        <span id="scanProgressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="scanProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto mb-4">
                    <div id="scanLogs" class="space-y-2">
                        <!-- Scan logs will appear here -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button id="stopScanBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                        <i class="fas fa-stop mr-2"></i>Stop Scan
                    </button>
                    <button onclick="closeScanModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                        <i class="fas fa-eye mr-2"></i>View in Background
                    </button>
                </div>
            </div>
        </div>

        <!-- Harvested Endpoints Modal -->
        <div id="harvestedEndpointsModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-green-400">
                        <i class="fas fa-database mr-2"></i>Harvested Endpoints
                    </h3>
                    <button onclick="closeHarvestedModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-gray-300">Total harvested: </span>
                            <span class="text-green-400 font-bold" id="totalHarvestedCount">0</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportHarvestedEndpoints()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                            <button onclick="clearHarvestedEndpoints()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                                <i class="fas fa-trash mr-2"></i>Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto">
                    <div id="harvestedEndpointsList" class="space-y-2">
                        <!-- Harvested endpoints will appear here -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="closeHarvestedModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket = io();
        let currentDiscoveryId = null;
        let currentScanId = null;
        let discoveredSubdomains = [];
        let selectedSubdomains = new Set();
        
        // Check tool status on page load
        fetch('/api/check_tools')
            .then(response => response.json())
            .then(tools => {
                const toolStatusDiv = document.getElementById('toolStatus');
                toolStatusDiv.innerHTML = '';
                
                for (const [tool, installed] of Object.entries(tools)) {
                    const status = installed ? 
                        `<div class="text-center p-3 bg-green-900/30 border border-green-700 rounded-lg">
                            <i class="fas fa-check-circle text-green-400 text-xl mb-1"></i>
                            <div class="font-medium">${tool}</div>
                            <div class="text-xs text-green-400">Installed</div>
                        </div>` :
                        `<div class="text-center p-3 bg-red-900/30 border border-red-700 rounded-lg">
                            <i class="fas fa-times-circle text-red-400 text-xl mb-1"></i>
                            <div class="font-medium">${tool}</div>
                            <div class="text-xs text-red-400">Not Installed</div>
                        </div>`;
                    toolStatusDiv.innerHTML += status;
                }
            });
        
        // Load endpoint harvesting status
        function loadHarvestingStatus() {
            fetch('/api/endpoint_harvesting_status')
                .then(response => response.json())
                .then(data => {
                    const checkbox = document.getElementById('endpoint_harvesting');
                    checkbox.checked = data.enabled;
                    document.getElementById('harvestedCount').textContent = data.count;
                });
        }
        
        // Load harvesting status on page load
        loadHarvestingStatus();
        
        // Toggle endpoint harvesting
        document.getElementById('endpoint_harvesting').addEventListener('change', function() {
            const enabled = this.checked;
            fetch('/api/toggle_endpoint_harvesting', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: enabled})
            })
            .then(response => response.json())
            .then(data => {
                loadHarvestingStatus();
                if (data.enabled) {
                    Swal.fire({
                        title: 'Endpoint Harvesting Enabled',
                        text: data.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        });
        
        // View harvested endpoints
        function viewHarvestedEndpoints() {
            fetch('/api/get_harvested_endpoints')
                .then(response => response.json())
                .then(data => {
                    const listDiv = document.getElementById('harvestedEndpointsList');
                    listDiv.innerHTML = '';
                    
                    if (data.endpoints && data.endpoints.length > 0) {
                        document.getElementById('totalHarvestedCount').textContent = data.count;
                        
                        data.endpoints.forEach((endpoint, index) => {
                            const div = document.createElement('div');
                            div.className = 'p-3 bg-gray-800 rounded-lg';
                            div.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div class="font-mono text-sm text-blue-300">${endpoint}</div>
                                    <button onclick="copyToClipboard('${endpoint}')" class="text-green-400 hover:text-green-300">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            `;
                            listDiv.appendChild(div);
                        });
                    } else {
                        listDiv.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-database text-2xl mb-2"></i>
                                <p>No endpoints harvested yet</p>
                                <p class="text-sm mt-2">Enable endpoint harvesting and run scans to collect endpoints</p>
                            </div>
                        `;
                    }
                    
                    document.getElementById('harvestedEndpointsModal').classList.remove('hidden');
                });
        }
        
        // Export harvested endpoints
        function exportHarvestedEndpoints() {
            window.open('/api/export_harvested_endpoints', '_blank');
        }
        
        // Clear harvested endpoints
        function clearHarvestedEndpoints() {
            Swal.fire({
                title: 'Clear All Harvested Endpoints?',
                text: 'This action cannot be undone',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, clear all',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/clear_harvested_endpoints', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(response => response.json())
                    .then(data => {
                        loadHarvestingStatus();
                        if (document.getElementById('harvestedEndpointsModal').classList.contains('hidden') === false) {
                            viewHarvestedEndpoints();
                        }
                        Swal.fire({
                            title: 'Cleared!',
                            text: data.message,
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    });
                }
            });
        }
        
        function closeHarvestedModal() {
            document.getElementById('harvestedEndpointsModal').classList.add('hidden');
        }
        
        // Handle discovery start
        document.getElementById('startDiscoveryBtn').addEventListener('click', function() {
            const domain = document.getElementById('domain').value;
            const tools = Array.from(document.querySelectorAll('input[name="tools"]:checked'))
                .map(cb => cb.value);
            
            if (!domain) {
                alert('Please enter a domain');
                return;
            }
            
            if (tools.length === 0) {
                alert('Please select at least one tool');
                return;
            }
            
            // Show discovery modal
            document.getElementById('discoveryProgressModal').classList.remove('hidden');
            document.getElementById('discoveryLogs').innerHTML = '';
            
            // Start discovery
            fetch('/api/start_subdomain_discovery', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    domain: domain,
                    tools: tools
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.scan_id) {
                    currentDiscoveryId = data.scan_id;
                    setupDiscoveryListeners();
                } else {
                    alert('Error: ' + data.error);
                    closeDiscoveryModal();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start discovery');
                closeDiscoveryModal();
            });
        });
        
        // Handle scan with selected subdomains
        document.getElementById('startSelectedScanBtn').addEventListener('click', function() {
            if (selectedSubdomains.size === 0) {
                alert('Please select at least one subdomain');
                return;
            }
            
            const scanMode = document.querySelector('input[name="scan_mode"]:checked').value;
            const verifyEndpoints = document.querySelector('input[name="verify_endpoints"]:checked').value;
            const jsAnalysis = document.querySelector('input[name="js_analysis"]:checked').value;
            const endpointHarvesting = document.getElementById('endpoint_harvesting').checked ? 'on' : 'off';
            
            // Show scan modal
            document.getElementById('scanProgressModal').classList.remove('hidden');
            document.getElementById('scanLogs').innerHTML = '';
            
            // Start scan with selected subdomains
            fetch('/api/start_selected_scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    scan_id: currentDiscoveryId,
                    selected_subdomains: Array.from(selectedSubdomains),
                    scan_mode: scanMode,
                    verify_endpoints: verifyEndpoints,
                    js_analysis: jsAnalysis,
                    endpoint_harvesting: endpointHarvesting
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.scan_id) {
                    currentScanId = data.scan_id;
                    setupScanListeners();
                } else {
                    alert('Error: ' + data.error);
                    closeScanModal();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start scan');
                closeScanModal();
            });
        });
        
        // Discovery socket listeners
        function setupDiscoveryListeners() {
            socket.on('scan_log', function(data) {
                if (data.scan_id === currentDiscoveryId) {
                    const logDiv = document.getElementById('discoveryLogs');
                    const logEntry = document.createElement('div');
                    logEntry.className = `p-2 rounded ${getLogClass(data.type)}`;
                    logEntry.innerHTML = `
                        <div class="flex items-start">
                            <i class="${getLogIcon(data.type)} mt-1 mr-2"></i>
                            <div>${data.message}</div>
                        </div>
                    `;
                    logDiv.appendChild(logEntry);
                    logDiv.scrollTop = logDiv.scrollHeight;
                    
                    updateDiscoveryProgress(data.message);
                }
            });
            
            socket.on('discovery_complete', function(data) {
                if (data.scan_id === currentDiscoveryId) {
                    addDiscoveryLog('Subdomain discovery completed!', 'success');
                    updateDiscoveryProgressBar(100);
                    
                    // Fetch discovered subdomains
                    fetch(`/api/get_discovered_subdomains/${currentDiscoveryId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.subdomains) {
                                discoveredSubdomains = data.subdomains;
                                
                                // Show success message
                                setTimeout(() => {
                                    Swal.fire({
                                        title: 'Discovery Complete!',
                                        html: `
                                            <div class="text-left">
                                                <p>Found ${data.subdomains.length} subdomains</p>
                                                <p>You can now select which ones to scan</p>
                                            </div>
                                        `,
                                        icon: 'success',
                                        confirmButtonText: 'Select Subdomains',
                                        showCancelButton: true,
                                        cancelButtonText: 'Close'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            closeDiscoveryModal();
                                            showSubdomainSelection(data.subdomains);
                                        } else {
                                            closeDiscoveryModal();
                                        }
                                    });
                                }, 1000);
                            }
                        });
                }
            });
            
            socket.on('discovery_error', function(data) {
                if (data.scan_id === currentDiscoveryId) {
                    addDiscoveryLog('Discovery failed: ' + data.message, 'error');
                    updateDiscoveryProgressBar(0);
                }
            });
        }
        
        // Scan socket listeners
        function setupScanListeners() {
            socket.on('scan_log', function(data) {
                if (data.scan_id === currentScanId) {
                    const logDiv = document.getElementById('scanLogs');
                    const logEntry = document.createElement('div');
                    logEntry.className = `p-2 rounded ${getLogClass(data.type)}`;
                    logEntry.innerHTML = `
                        <div class="flex items-start">
                            <i class="${getLogIcon(data.type)} mt-1 mr-2"></i>
                            <div>${data.message}</div>
                        </div>
                    `;
                    logDiv.appendChild(logEntry);
                    logDiv.scrollTop = logDiv.scrollHeight;
                    
                    updateScanProgress(data.message);
                }
            });
            
            socket.on('scan_complete', function(data) {
                if (data.scan_id === currentScanId) {
                    addScanLog('Scan completed successfully!', 'success');
                    updateScanProgressBar(100);
                    
                    // Reload harvesting status
                    loadHarvestingStatus();
                    
                    // Store the scan ID in localStorage for later access
                    localStorage.setItem('last_scan_id', currentScanId);
                    
                    // Show success message with option to view results
                    setTimeout(() => {
                        Swal.fire({
                            title: 'Scan Complete!',
                            html: `
                                <div class="text-left">
                                    <p>Domain: ${data.results.domain}</p>
                                    <p>Selected subdomains: ${data.results.selected_subdomains.length}</p>
                                    <p>Live URLs found: ${data.results.live_urls.length}</p>
                                    <p>Endpoints discovered: ${data.results.katana_urls.length}</p>
                                    <p>JS files analyzed: ${data.results.interesting_js_files.length}</p>
                                    <p>Secrets found: ${data.results.scan_summary.secrets_found}</p>
                                    <p>High priority endpoints: ${data.results.scan_summary.high_priority_endpoints}</p>
                                    <p>Endpoints harvested: ${data.results.endpoint_harvesting.harvested_count}</p>
                                </div>
                            `,
                            icon: 'success',
                            confirmButtonText: 'View Results',
                            showCancelButton: true,
                            cancelButtonText: 'Close'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = `/scan/${currentScanId}`;
                            } else {
                                closeScanModal();
                            }
                        });
                    }, 1000);
                }
            });
            
            socket.on('scan_error', function(data) {
                if (data.scan_id === currentScanId) {
                    addScanLog('Scan failed: ' + data.message, 'error');
                    updateScanProgressBar(0);
                    
                    Swal.fire({
                        title: 'Scan Failed',
                        text: data.message,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }
        
        // Subdomain selection functions
        function showSubdomainSelection(subdomains) {
            document.getElementById('discoveryForm').classList.add('hidden');
            document.getElementById('subdomainSelection').classList.remove('hidden');
            
            document.getElementById('totalCount').textContent = subdomains.length;
            updateSelectedCount();
            
            const subdomainList = document.getElementById('subdomainList');
            subdomainList.innerHTML = '';
            
            subdomains.forEach(subdomain => {
                const isImportant = isImportantSubdomain(subdomain);
                const div = document.createElement('div');
                div.className = `subdomain-item flex items-center justify-between p-3 mb-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-750`;
                div.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" id="sub_${subdomain}" value="${subdomain}" 
                               class="checkbox-custom mr-3" onchange="toggleSubdomain('${subdomain}')">
                        <div>
                            <div class="font-medium ${isImportant ? 'text-yellow-300' : 'text-gray-300'}">
                                ${subdomain}
                                ${isImportant ? '<span class="ml-2 text-xs bg-yellow-900/30 text-yellow-400 px-2 py-1 rounded">Important</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                subdomainList.appendChild(div);
                
                // Auto-select important subdomains
                if (isImportant && !selectedSubdomains.has(subdomain)) {
                    selectedSubdomains.add(subdomain);
                    div.classList.add('selected');
                    document.getElementById(`sub_${subdomain}`).checked = true;
                }
            });
            
            updateSelectedCount();
        }
        
        function showDiscoveryForm() {
            document.getElementById('subdomainSelection').classList.add('hidden');
            document.getElementById('discoveryForm').classList.remove('hidden');
            selectedSubdomains.clear();
        }
        
        function toggleSubdomain(subdomain) {
            const checkbox = document.getElementById(`sub_${subdomain}`);
            const item = checkbox.closest('.subdomain-item');
            
            if (checkbox.checked) {
                selectedSubdomains.add(subdomain);
                item.classList.add('selected');
            } else {
                selectedSubdomains.delete(subdomain);
                item.classList.remove('selected');
            }
            
            updateSelectedCount();
        }
        
        function selectAll() {
            discoveredSubdomains.forEach(subdomain => {
                selectedSubdomains.add(subdomain);
                const checkbox = document.getElementById(`sub_${subdomain}`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('.subdomain-item').classList.add('selected');
                }
            });
            updateSelectedCount();
        }
        
        function deselectAll() {
            selectedSubdomains.clear();
            discoveredSubdomains.forEach(subdomain => {
                const checkbox = document.getElementById(`sub_${subdomain}`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.closest('.subdomain-item').classList.remove('selected');
                }
            });
            updateSelectedCount();
        }
        
        function isImportantSubdomain(subdomain) {
            const importantPatterns = ['admin', 'api', 'dev', 'test', 'staging', 'mail', 'webmail', 'portal', 'dashboard', 'secure', 'vpn', 'ssh', 'ftp'];
            return importantPatterns.some(pattern => subdomain.toLowerCase().includes(pattern));
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedSubdomains.size;
        }
        
        // Logging functions
        function addDiscoveryLog(message, type) {
            const logDiv = document.getElementById('discoveryLogs');
            addLogEntry(logDiv, message, type);
        }
        
        function addScanLog(message, type) {
            const logDiv = document.getElementById('scanLogs');
            addLogEntry(logDiv, message, type);
        }
        
        function addLogEntry(logDiv, message, type) {
            const logEntry = document.createElement('div');
            logEntry.className = `p-2 rounded ${getLogClass(type)}`;
            logEntry.innerHTML = `
                <div class="flex items-start">
                    <i class="${getLogIcon(type)} mt-1 mr-2"></i>
                    <div>${message}</div>
                </div>
            `;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function getLogClass(type) {
            switch(type) {
                case 'success': return 'bg-green-900/30 border border-green-700';
                case 'error': return 'bg-red-900/30 border border-red-700';
                case 'warning': return 'bg-yellow-900/30 border border-yellow-700';
                default: return 'bg-blue-900/30 border border-blue-700';
            }
        }
        
        function getLogIcon(type) {
            switch(type) {
                case 'success': return 'fas fa-check-circle text-green-400';
                case 'error': return 'fas fa-times-circle text-red-400';
                case 'warning': return 'fas fa-exclamation-triangle text-yellow-400';
                default: return 'fas fa-info-circle text-blue-400';
            }
        }
        
        // Progress functions
        function updateDiscoveryProgress(message) {
            document.getElementById('discoveryProgressText').textContent = message;
            const progressBar = document.getElementById('discoveryProgressBar');
            let currentWidth = parseInt(progressBar.style.width) || 0;
            if (currentWidth < 90) {
                currentWidth += 5;
                progressBar.style.width = currentWidth + '%';
                document.getElementById('discoveryProgressPercent').textContent = currentWidth + '%';
            }
        }
        
        function updateDiscoveryProgressBar(percent) {
            const progressBar = document.getElementById('discoveryProgressBar');
            progressBar.style.width = percent + '%';
            document.getElementById('discoveryProgressPercent').textContent = percent + '%';
        }
        
        function updateScanProgress(message) {
            document.getElementById('scanProgressText').textContent = message;
            const progressBar = document.getElementById('scanProgressBar');
            let currentWidth = parseInt(progressBar.style.width) || 0;
            if (currentWidth < 90) {
                currentWidth += 5;
                progressBar.style.width = currentWidth + '%';
                document.getElementById('scanProgressPercent').textContent = currentWidth + '%';
            }
        }
        
        function updateScanProgressBar(percent) {
            const progressBar = document.getElementById('scanProgressBar');
            progressBar.style.width = percent + '%';
            document.getElementById('scanProgressPercent').textContent = percent + '%';
        }
        
        // Modal functions
        function closeDiscoveryModal() {
            document.getElementById('discoveryProgressModal').classList.add('hidden');
        }
        
        function closeScanModal() {
            document.getElementById('scanProgressModal').classList.add('hidden');
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    title: 'Copied!',
                    text: 'Text copied to clipboard',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }
        
        // Stop buttons
        document.getElementById('stopDiscoveryBtn').addEventListener('click', function() {
            if (currentDiscoveryId) {
                fetch(`/api/stop_scan/${currentDiscoveryId}`, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        addDiscoveryLog('Discovery stopped by user', 'warning');
                    });
            }
        });
        
        document.getElementById('stopScanBtn').addEventListener('click', function() {
            if (currentScanId) {
                fetch(`/api/stop_scan/${currentScanId}`, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        addScanLog('Scan stopped by user', 'warning');
                    });
            }
        });
    </script>
</body>
</html>
